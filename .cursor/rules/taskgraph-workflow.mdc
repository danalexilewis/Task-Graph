---
description: Task-Graph plan creation, review protocol, import, and execution loop
alwaysApply: true
---

# Task-Graph Workflow

## Orientation

Before executing any plan, run `pnpm tg status` to see what's outstanding. If there are stale `doing` tasks or forgotten `todo` tasks for completed work, clean them up first (see Recovery below).

## Plan Creation and Review

- **Plans** live in `plans/<name>.md` in Cursor format (YAML frontmatter with `name`, `overview`, `todos`).
- After creating a plan: summarize it, then **pause** and ask for review. Do not import or execute until the user responds.

### Interpreting User Response

| User says | Action |
|-----------|--------|
| proceed, go ahead, execute, run it, let's do it | Import plan to taskgraph, then execute tasks |
| just add the tasks, add to taskgraph only | Import only; do not execute |
| thanks, that's good, looks good, ok, don't do anything | Do nothing (acknowledgement only) |

### Import Command

```bash
pnpm tg import plans/<file> --plan "<Plan Name>" --format cursor
```

## Execution Loop (per task — MANDATORY)

For EACH task, follow ALL steps in order. Never skip start, never defer done.

1. `pnpm tg start <taskId>` — **MUST** run before doing any work
2. `pnpm tg context <taskId>` — Read the output: domain doc path (`docs/<domain>.md`), skill guide path (`docs/skills/<skill>.md`), and related done tasks. Load those docs before coding.
3. Do the work (stay within scope)
4. `pnpm tg done <taskId> --evidence "..."` — **MUST** run immediately after work is complete

Evidence should include: tests run, commands, git hashes.

### Multi-task discipline

When executing N tasks in sequence, complete the full start→work→done cycle for each one individually. Never batch-skip transitions.

### Plan completion

After marking the last task in a plan as done, run:
```bash
pnpm tg export markdown --plan <planId> --out plans/<file>
```
This updates the plan file with final statuses, closing the round-trip.

## Recovery (out-of-sync tasks)

If work is already done but the task is still `todo` or `doing` in taskgraph:

- **Task is `todo`**: `pnpm tg done <taskId> --force --evidence "completed previously"`
- **Task is `doing`**: `pnpm tg done <taskId> --evidence "completed previously"`

Run `pnpm tg status` after cleanup to verify.

## When Blocked

- `pnpm tg block <taskId> --on <blockerId> --reason "..."`
- If blocker does not exist: create a new task with owner=human, then block on it.
